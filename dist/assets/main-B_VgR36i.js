const X="/.netlify/functions";function W(a){return String(a).padStart(2,"0")}function G(a,y=null,o=20,i=30,c=0){if(!a)return[];const r=a.split("-").map(t=>parseInt(t,10));if(r.length!==3||r.some(isNaN))return[];const[u,f,m]=r,l=new Date(u,f-1,m).getDay(),L=l===0?7:l,x=y?y[L]||null:{1:{start:"15:00",end:"17:00"},2:{start:"15:00",end:"19:00"},3:{start:"15:00",end:"19:00"},4:{start:"14:00",end:"19:00"},5:{start:"15:30",end:"19:00"},6:null,7:null}[L]||null;if(!x)return[];const[I,U]=x.start.split(":").map(t=>parseInt(t,10)),[N,H]=x.end.split(":").map(t=>parseInt(t,10));let S=new Date(u,f-1,m,I,U,0,0);const T=new Date(u,f-1,m,N,H,0,0),D=[],e=Number(o);for(;S.getTime()+(e+c)*6e4<=T.getTime();){const t=S.getMinutes(),n=t%30===0?0:30-t%30,s=new Date(S.getTime()+n*6e4);if(s.getTime()+e*6e4<=T.getTime()&&D.push(`${W(s.getHours())}:${W(s.getMinutes())}`),S=new Date(S.getTime()+i*6e4),D.length>500)break}return Array.from(new Set(D)).sort()}async function Q(a){if(!a)return{date:null,disabled:!0,slots:[]};try{const m=`${X}/availability?date=${encodeURIComponent(a)}`,p=await fetch(m,{cache:"no-cache"});if(p.ok){const l=await p.json();if(!l||typeof l!="object")throw new Error("Invalid JSON from availability function");return Array.isArray(l.slots)||(l.slots=[]),l}else console.warn("[client availability] server returned non-ok",p.status)}catch(m){console.warn("[client availability] server fetch failed, using client fallback",m)}const o=G(a).map(m=>({time:m,isDisabled:!1})),i=a.split("-").map(m=>parseInt(m,10)),r=new Date(i[0],i[1]-1,i[2]).getDay(),u=r===0?7:r;return{date:a,disabled:u===6||u===7,slots:o}}async function V(a){const y=`${X}/book`;try{const o=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),i=await o.text();let c;try{c=JSON.parse(i)}catch{c={message:i}}return{ok:o.ok,body:c,status:o.status}}catch(o){return console.error("[booking] network error",o),{ok:!1,body:{message:"network error"},status:0}}}const O=new Map,A=new Map,C={token:0},ee=6;function K(a=document){var T,D;console.debug("[booking] main loaded");const y=a.querySelector("#booking-form"),o=a.querySelector("#timeslots");if(!y){const e=Number(((T=a==null?void 0:a.dataset)==null?void 0:T.bookingInitRetry)||0);if(e<4){a!=null&&a.dataset&&(a.dataset.bookingInitRetry=String(e+1)),setTimeout(()=>K(a),120),console.debug("[booking] booking form not found; retrying init",e+1);return}console.warn("[booking] booking form not found; booking module disabled.");return}if(!o){const e=Number(((D=a==null?void 0:a.dataset)==null?void 0:D.bookingInitRetry)||0);if(e<4){a!=null&&a.dataset&&(a.dataset.bookingInitRetry=String(e+1)),setTimeout(()=>K(a),120),console.debug("[booking] timeslots container missing; retrying init",e+1);return}console.warn("[booking] timeslots container missing; booking module disabled.");return}const i=a.querySelector("#calendar-root")||function(){const e=document.createElement("div");return e.className="calendar",(a.querySelector(".date-container")||a).appendChild(e),e}();if(a!=null&&a.dataset&&delete a.dataset.bookingInitRetry,i.dataset.bookingInit==="1"){console.debug("[booking] calendar already initialized; skipping duplicate init");return}i.dataset.bookingInit="1";let c=y.querySelector('input[name="startLocal"]');c||(c=document.createElement("input"),c.type="hidden",c.name="startLocal",y.appendChild(c));let r=new Date;r.setDate(1);let u=null,f=null;function m(e){const t=e.querySelector(".calendar-month-header");if(t)return{prevBtn:t.querySelector(".calendar-prev"),nextBtn:t.querySelector(".calendar-next"),monthLabel:t.querySelector(".calendar-month-label")};const n=document.createElement("div");n.className="calendar-month-header",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.marginBottom="8px";const s=document.createElement("button");s.className="calendar-prev",s.type="button",s.textContent="‹";const h=document.createElement("div");h.className="calendar-month-label";const b=document.createElement("button");return b.className="calendar-next",b.type="button",b.textContent="›",n.appendChild(s),n.appendChild(h),n.appendChild(b),e.insertBefore(n,e.firstChild),{prevBtn:s,nextBtn:b,monthLabel:h}}const p=m(i);if(!i.querySelector(".calendar-header")){const e=document.createElement("div");e.className="calendar-header",["Mo","Di","Mi","Do","Fr","Sa","So"].forEach(t=>{const n=document.createElement("span");n.textContent=t,e.appendChild(n)}),i.appendChild(e)}let l=i.querySelector(".calendar-grid");l||(l=document.createElement("div"),l.className="calendar-grid",i.appendChild(l));const L=e=>String(e).padStart(2,"0"),P=(e,t,n)=>`${e}-${L(t)}-${L(n)}`,x=e=>e.toLocaleDateString("de-DE",{month:"long",year:"numeric"});async function I(e){if(O.has(e))return O.get(e);if(A.has(e))return A.get(e);const t=Q(e).then(n=>(O.set(e,n),A.delete(e),n)).catch(n=>{throw A.delete(e),n});return A.set(e,t),t}function U(e,t){if(!e.length)return Promise.resolve();let n=0;const s=Math.min(ee,e.length),h=Array.from({length:s},async()=>{for(;n<e.length;){const b=n++;if(t!==C.token)return;await e[b]()}});return Promise.all(h)}async function N(){const e=++C.token;l.innerHTML="",p.monthLabel.textContent=x(r);const t=r.getFullYear(),n=r.getMonth(),s=new Date(t,n,1),b=new Date(t,n+1,0).getDate(),g=(s.getDay()+6)%7,q=g+b,F=Math.ceil(q/7),B=new Date;B.setHours(0,0,0,0);let k=1;const w=document.createDocumentFragment(),R=[];for(let M=0;M<F;M++){const $=document.createElement("div");$.className="calendar-row",$.style.display="flex";for(let _=0;_<7;_++){const Z=M*7+_,E=document.createElement("div");if(E.className="calendar-cell",E.style.flex="1",E.style.padding="4px",Z<g||k>b){const v=document.createElement("button");v.type="button",v.className="calendar-day empty",v.disabled=!0,v.style.visibility="hidden",E.appendChild(v)}else{const v=P(t,n+1,k),d=document.createElement("button");d.type="button",d.className="calendar-day is-loading",d.textContent=String(k),d.dataset.date=v;const Y=new Date(t,n,k);Y.setHours(0,0,0,0),Y<B?(d.classList.add("is-disabled"),d.classList.remove("is-loading"),d.disabled=!0):(d.disabled=!0,R.push(async()=>{try{const j=await I(v);if(e!==C.token)return;const J=!!(j&&j.disabled);d.classList.toggle("is-disabled",J),d.disabled=J}catch(j){if(e!==C.token)return;d.classList.add("is-disabled"),d.disabled=!0,console.warn("[booking] isDateDisabled error",j)}finally{e===C.token&&d.classList.remove("is-loading")}})),E.appendChild(d),k++}$.appendChild(E)}w.appendChild($)}l.appendChild(w),U(R,e).catch(M=>{e===C.token&&console.warn("[booking] calendar availability batch failed",M)})}async function H(e){const t=await I(e);return!t||!Array.isArray(t.slots)?[]:t.slots.filter(n=>!n.isDisabled).map(n=>n.time)}function S(e){if(o.innerHTML="",!Array.isArray(e)||e.length===0){o.textContent="Keine verfügbaren Zeiten";return}e.forEach(t=>{const n=document.createElement("button");n.type="button",n.className="timeslot",n.textContent=t,n.addEventListener("click",()=>{o.querySelectorAll(".timeslot").forEach(s=>s.classList.remove("is-active")),n.classList.add("is-active"),f=t,u&&(c.value=`${u}T${f}:00`)}),o.appendChild(n)})}l.dataset.bound||(l.addEventListener("click",async e=>{const t=e.target.closest(".calendar-day");if(!t||t.classList.contains("empty")||t.classList.contains("is-disabled")||t.classList.contains("is-loading")||t.disabled)return;e.preventDefault(),u=t.dataset.date,i.querySelectorAll(".calendar-day").forEach(s=>s.classList.remove("is-active")),t.classList.add("is-active");const n=await H(u);S(n)}),l.dataset.bound="true"),p.prevBtn.addEventListener("click",()=>{r=new Date(r.getFullYear(),r.getMonth()-1,1),N()}),p.nextBtn.addEventListener("click",()=>{r=new Date(r.getFullYear(),r.getMonth()+1,1),N()}),y.addEventListener("submit",async e=>{var q,F,B,k;e.preventDefault();const t=(((q=a.querySelector("#bookingName"))==null?void 0:q.value)||"").trim(),n=(((F=a.querySelector("#bookingEmail"))==null?void 0:F.value)||"").trim(),s=(((B=a.querySelector("#bookingPhone"))==null?void 0:B.value)||"").trim(),h="Europe/Berlin";if(!t){alert("Bitte geben Sie Ihren Namen ein.");return}if(!n||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)){alert("Bitte geben Sie eine gültige E-Mail-Adresse ein.");return}if(!u||!f){alert("Bitte wählen Sie ein Datum und eine Uhrzeit aus.");return}const b=typeof(crypto==null?void 0:crypto.randomUUID)=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,z={name:t,email:n,phone:s,startLocal:c.value,timezone:h,idempotencyKey:b,source:"website"},g=y.querySelector('button[type="submit"]');g&&(g.disabled=!0,g.dataset.origText=g.textContent,g.textContent="Wird gebucht…");try{const w=await V(z);w.ok?(alert("Termin gebucht! Eine Bestätigung wird an Ihre E-Mail gesendet."),y.reset(),o.innerHTML="",i.querySelectorAll(".calendar-day").forEach(R=>R.classList.remove("is-active")),u=null,f=null):(console.error("[booking] booking failed",w),alert("Fehler beim Buchen: "+(((k=w.body)==null?void 0:k.message)||"Serverantwort unklar")))}catch(w){console.error("[booking] network error",w),alert("Netzwerkfehler. Bitte versuchen Sie es später erneut.")}finally{g&&(g.disabled=!1,g.textContent=g.dataset.origText||"jetzt kostenloses Erstgespräch buchen")}}),(async()=>(await N(),console.log("[booking] calendar ready")))()}export{K as initBookingPage};
